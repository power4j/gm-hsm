name: CI

on:
  push:
    branches: [ main, master, develop, dev ]
  pull_request:
    branches: [ main, master, develop, dev ]

env:
  CARGO_TERM_COLOR: always
  CACHE_PATHS: |
    ~/.cargo/bin/
    ~/.cargo/registry/index/
    ~/.cargo/registry/cache/
    ~/.cargo/git/db/
    target/

jobs:
  # 基础代码验证
  validity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_PATHS }}
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check source is valid
        run: cargo check --workspace

  formating:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - name: Check Rust formatting with rustfmt
        run: cargo fmt --all --check

  # 跨平台编译测试（核心功能）
  cross-platform-build:
    needs: validity
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
        features:
          - name: "default"
            flags: ""
          - name: "all-features"
            flags: "--all-features"

    steps:
      - uses: actions/checkout@v5
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      - uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_PATHS }}
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build (${{ matrix.os }}, ${{ matrix.features.name }})
        run: cargo build --workspace --verbose ${{ matrix.features.flags }}

  # 详细测试（仅在Ubuntu运行，减少CI时间）
  detailed-tests:
    needs: validity
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # 测试不同特性组合
          - name: "default-features"
            features: ""
          - name: "skf-only"
            features: "--features skf"
          - name: "sdf-with-dll"
            features: "--features sdf,dll"
          - name: "all-features"
            features: "--all-features"

    steps:
      - uses: actions/checkout@v5
      - uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_PATHS }}
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Run tests (${{ matrix.name }})
        run: cargo test --workspace --verbose ${{ matrix.features }}

  # 跨平台Clippy检查
  clippy:
    needs: validity
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest

    steps:
      - uses: actions/checkout@v5
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy
      - uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_PATHS }}
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Lint code with clippy (${{ matrix.os }})
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  # Windows平台特定测试（验证我们修复的问题）
  windows-specific-tests:
    needs: cross-platform-build
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      - uses: actions/cache@v4
        with:
          path: ${{ env.CACHE_PATHS }}
          key: ${{ runner.os }}-cargo-windows-${{ hashFiles('**/Cargo.lock') }}

      - name: Test Windows compilation (c_ulong = 4 bytes)
        run: |
          cargo build --workspace --verbose --all-features
          cargo test --workspace --verbose --all-features

      - name: Verify c_ulong size expectations
        run: |
          # 验证我们的修复是否正确处理了平台差异
          cargo check --workspace --all-features

  # 发布前检查
  publish-ability:
    runs-on: ubuntu-latest
    needs: [cross-platform-build, clippy]
    steps:
      - uses: actions/checkout@v5
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Check that it will publish to crates
        run: |
          cargo publish --no-verify --dry-run -p gm-hsm-sys
          cargo publish --no-verify --dry-run -p gm-hsm-skf
          cargo publish --no-verify --dry-run -p gm-hsm-sdf
        shell: bash