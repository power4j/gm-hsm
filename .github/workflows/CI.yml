name: CI

on:
  push:
    branches: [ main, master, develop, dev ]
  pull_request:
    branches: [ main, master, develop, dev ]
  workflow_dispatch: # 允许人工触发

env:
  CARGO_TERM_COLOR: always
  CACHE_PATHS: |
    ~/.cargo/bin/
    ~/.cargo/registry/index/
    ~/.cargo/registry/cache/
    ~/.cargo/git/db/
    target/

jobs:
  validity:
    runs-on: ubuntu-latest
    # PR时必须成功，push时允许失败
    continue-on-error: ${{ github.event_name != 'pull_request' }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - uses: actions/cache@v5
        with:
          path: ${{ env.CACHE_PATHS }}
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check source is valid
        run: cargo check --workspace

  formating:
    runs-on: ubuntu-latest
    # PR时必须成功，push时允许失败
    continue-on-error: ${{ github.event_name != 'pull_request' }}
    steps:
      - uses: actions/checkout@v6
      - name: Check Rust formatting with rustfmt
        run: cargo fmt --all --check

  test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
        features:
          - name: "default-features"
            flags: ""
          - name: "skf-only"
            flags: "--features skf"
          - name: "sdf-with-dll"
            flags: "--features sdf,dll"
          - name: "all-features"
            flags: "--all-features"

    steps:
      - uses: actions/checkout@v6
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
      - uses: actions/cache@v5
        with:
          path: ${{ env.CACHE_PATHS }}
          key: ${{ runner.os }}-${{ matrix.features.name }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build (${{ matrix.os }}, ${{ matrix.features.name }})
        run: cargo build --workspace --verbose ${{ matrix.features.flags }}

      - name: Run tests (${{ matrix.os }}, ${{ matrix.features.name }})
        run: cargo test --workspace --verbose ${{ matrix.features.flags }}

  clippy:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest

    steps:
      - uses: actions/checkout@v6
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable
          components: clippy
      - uses: actions/cache@v5
        with:
          path: ${{ env.CACHE_PATHS }}
          key: ${{ runner.os }}-cargo-clippy-${{ hashFiles('**/Cargo.lock') }}

      - name: Lint code with clippy (${{ matrix.os }})
        run: cargo clippy --workspace --all-targets --all-features -- -D warnings

  # 发布前检查
  publish-ability:
    runs-on: ubuntu-latest
    needs: [test, clippy]
    steps:
      - uses: actions/checkout@v6
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Check that it will publish to crates
        run: |
          cargo publish --no-verify --dry-run -p gm-hsm-sys
          cargo publish --no-verify --dry-run -p gm-hsm-skf
          cargo publish --no-verify --dry-run -p gm-hsm-sdf
        shell: bash