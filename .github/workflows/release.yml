name: Publish crates on crates.io

on:
  workflow_dispatch:
    inputs:
      gm-hsm-sys-version:
        description: "gm-hsm-sys: Version bump type or custom version"
        required: false
        default: "none"
        type: choice
        options:
          - "none"
          - "major"
          - "minor"
          - "patch"
          - "alpha"
          - "beta"
          - "rc"
      gm-hsm-sys-custom-version:
        description: "gm-hsm-sys: Custom semver (e.g., 1.2.3, 1.2.3-alpha.1, 1.2.3-rc.1)"
        required: false
        default: ""
      gm-hsm-skf-version:
        description: "gm-hsm-skf: Version bump type or custom version"
        required: false
        default: "none"
        type: choice
        options:
          - "none"
          - "major"
          - "minor"
          - "patch"
          - "alpha"
          - "beta"
          - "rc"
      gm-hsm-skf-custom-version:
        description: "gm-hsm-skf: Custom semver (e.g., 1.2.3, 1.2.3-alpha.1, 1.2.3-rc.1)"
        required: false
        default: ""
      gm-hsm-sdf-version:
        description: "gm-hsm-sdf: Version bump type or custom version"
        required: false
        default: "none"
        type: choice
        options:
          - "none"
          - "major"
          - "minor"
          - "patch"
          - "alpha"
          - "beta"
          - "rc"
      gm-hsm-sdf-custom-version:
        description: "gm-hsm-sdf: Custom semver (e.g., 1.2.3, 1.2.3-alpha.1, 1.2.3-rc.1)"
        required: false
        default: ""

#permissions:                    # Global permissions configuration starts here
#  contents: read                # 'read' access to repository contents
#  pull-requests: write          # 'write' access to pull requests

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:                # Job-level permissions configuration starts here
      contents: write           # 'write' access to repository contents
      pull-requests: write      # 'write' access to pull requests
    steps:
      - uses: actions/checkout@v6
        with:
          persist-credentials: false # otherwise, the token used is the GITHUB_TOKEN, instead of your personal token
          fetch-depth: 0             # otherwise, you will fail to push refs to dest repo
          #ref: ${{ github.head_ref }}
      - uses: actions-rust-lang/setup-rust-toolchain@v1
      - name: Set git credentials
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      # Rust toolchain is already set up by actions-rust-lang/setup-rust-toolchain@v1 above

      - name: Install tools
        run: |
          cargo install -q cargo-get cargo-edit

      # gm-hsm-sys release process
      - name: "[gm-hsm-sys] Bump version"
        if: "${{ github.event.inputs.gm-hsm-sys-version != 'none' }}"
        run: |
          if [ "${{ github.event.inputs.gm-hsm-sys-version }}" = "alpha" ] || [ "${{ github.event.inputs.gm-hsm-sys-version }}" = "beta" ] || [ "${{ github.event.inputs.gm-hsm-sys-version }}" = "rc" ]; then
            # Handle pre-release versions
            PRE_SUFFIX="${{ github.event.inputs.gm-hsm-sys-version }}"
            CURRENT_VERSION=$(cd gm-hsm-sys && cargo get package.version --pretty)
            # Remove any existing pre-release suffix and analyze version
            BASE_VERSION=$(echo $CURRENT_VERSION | sed 's/-.*//')
            MAJOR=$(echo $BASE_VERSION | awk -F. '{print $1}')
            MINOR=$(echo $BASE_VERSION | awk -F. '{print $2}')
            PATCH=$(echo $BASE_VERSION | awk -F. '{print $3}')

            if echo $CURRENT_VERSION | grep -q "${PRE_SUFFIX}"; then
              # Already a pre-release version, keep same base, increment prerelease number
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            else
              # Stable version to pre-release: bump minor version (not patch!)
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="${MAJOR}.${NEW_MINOR}.0"
            fi
            # Set pre-release version with incrementing number
            if echo $CURRENT_VERSION | grep -q "${PRE_SUFFIX}"; then
              # Increment existing pre-release number
              CURRENT_PRERELEASE=$(echo $CURRENT_VERSION | sed "s/.*-${PRE_SUFFIX}\.\?//" | grep -o '[0-9]*' | head -1)
              if [ -z "$CURRENT_PRERELEASE" ]; then
                CURRENT_PRERELEASE=1
              else
                CURRENT_PRERELEASE=$((CURRENT_PRERELEASE + 1))
              fi
            else
              CURRENT_PRERELEASE=1
            fi
            FINAL_VERSION="${NEW_VERSION}-${PRE_SUFFIX}.${CURRENT_PRERELEASE}"
            # Remove 'v' prefix if present and add quotes
            CLEAN_VERSION=$(echo $FINAL_VERSION | sed 's/^v//')
            cargo set-version "$CLEAN_VERSION" -p gm-hsm-sys
          elif [ -n "${{ github.event.inputs.gm-hsm-sys-custom-version }}" ]; then
            # Use custom version (remove 'v' prefix if present)
            CLEAN_CUSTOM_VERSION=$(echo "${{ github.event.inputs.gm-hsm-sys-custom-version }}" | sed 's/^v//')
            cargo set-version "$CLEAN_CUSTOM_VERSION" -p gm-hsm-sys
          else
            # Standard semantic version bump
            cargo set-version --bump "${{ github.event.inputs.gm-hsm-sys-version }}" -p gm-hsm-sys
          fi
          CRATE_TAG="$(cd gm-hsm-sys && cargo get package.name)-$(cd gm-hsm-sys && cargo get package.version --pretty)"
          echo "CRATE_TAG=$CRATE_TAG" >> $GITHUB_ENV
          echo "CRATE_NAME=gm-hsm-sys" >> $GITHUB_ENV
          git add .
          git commit -am "Release: $CRATE_TAG"
          git tag "$CRATE_TAG"

      - name: "[gm-hsm-sys] Push to repository"
        if: "${{ github.event.inputs.gm-hsm-sys-version != 'none' }}"
        uses: ad-m/github-push-action@master
        with:
          branch: ${{ github.ref }}
          tags: true

      - name: "[gm-hsm-sys] Publish to crates.io"
        if: "${{ github.event.inputs.gm-hsm-sys-version != 'none' }}"
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN  }}
        run: cargo publish --no-verify -p gm-hsm-sys

      # gm-hsm-skf release process
      - name: "[gm-hsm-skf] Bump version"
        if: "${{ github.event.inputs.gm-hsm-skf-version != 'none' }}"
        run: |
          if [ "${{ github.event.inputs.gm-hsm-skf-version }}" = "alpha" ] || [ "${{ github.event.inputs.gm-hsm-skf-version }}" = "beta" ] || [ "${{ github.event.inputs.gm-hsm-skf-version }}" = "rc" ]; then
            # Handle pre-release versions
            PRE_SUFFIX="${{ github.event.inputs.gm-hsm-skf-version }}"
            CURRENT_VERSION=$(cd gm-hsm-skf && cargo get package.version --pretty)
            # Remove any existing pre-release suffix and analyze version
            BASE_VERSION=$(echo $CURRENT_VERSION | sed 's/-.*//')
            MAJOR=$(echo $BASE_VERSION | awk -F. '{print $1}')
            MINOR=$(echo $BASE_VERSION | awk -F. '{print $2}')
            PATCH=$(echo $BASE_VERSION | awk -F. '{print $3}')

            if echo $CURRENT_VERSION | grep -q "${PRE_SUFFIX}"; then
              # Already a pre-release version, keep same base, increment prerelease number
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            else
              # Stable version to pre-release: bump minor version (not patch!)
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="${MAJOR}.${NEW_MINOR}.0"
            fi
            # Set pre-release version with incrementing number
            if echo $CURRENT_VERSION | grep -q "${PRE_SUFFIX}"; then
              # Increment existing pre-release number
              CURRENT_PRERELEASE=$(echo $CURRENT_VERSION | sed "s/.*-${PRE_SUFFIX}\.\?//" | grep -o '[0-9]*' | head -1)
              if [ -z "$CURRENT_PRERELEASE" ]; then
                CURRENT_PRERELEASE=1
              else
                CURRENT_PRERELEASE=$((CURRENT_PRERELEASE + 1))
              fi
            else
              CURRENT_PRERELEASE=1
            fi
            FINAL_VERSION="${NEW_VERSION}-${PRE_SUFFIX}.${CURRENT_PRERELEASE}"
            # Remove 'v' prefix if present and add quotes
            CLEAN_VERSION=$(echo $FINAL_VERSION | sed 's/^v//')
            cargo set-version "$CLEAN_VERSION" -p gm-hsm-skf
          elif [ -n "${{ github.event.inputs.gm-hsm-skf-custom-version }}" ]; then
            # Use custom version (remove 'v' prefix if present)
            CLEAN_CUSTOM_VERSION=$(echo "${{ github.event.inputs.gm-hsm-skf-custom-version }}" | sed 's/^v//')
            cargo set-version "$CLEAN_CUSTOM_VERSION" -p gm-hsm-skf
          else
            # Standard semantic version bump
            cargo set-version --bump "${{ github.event.inputs.gm-hsm-skf-version }}" -p gm-hsm-skf
          fi
          CRATE_TAG="$(cd gm-hsm-skf && cargo get package.name)-$(cd gm-hsm-skf && cargo get package.version --pretty)"
          echo "CRATE_TAG=$CRATE_TAG" >> $GITHUB_ENV
          echo "CRATE_NAME=gm-hsm-skf" >> $GITHUB_ENV
          git add .
          git commit -am "Release: $CRATE_TAG"
          git tag "$CRATE_TAG"

      - name: "[gm-hsm-skf] Push to repository"
        if: "${{ github.event.inputs.gm-hsm-skf-version != 'none' }}"
        uses: ad-m/github-push-action@master
        with:
          branch: ${{ github.ref }}
          tags: true

      - name: "[gm-hsm-skf] Publish to crates.io"
        if: "${{ github.event.inputs.gm-hsm-skf-version != 'none' }}"
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN  }}
        run: cargo publish --no-verify -p gm-hsm-skf

      # gm-hsm-sdf release process
      - name: "[gm-hsm-sdf] Bump version"
        if: "${{ github.event.inputs.gm-hsm-sdf-version != 'none' }}"
        run: |
          if [ "${{ github.event.inputs.gm-hsm-sdf-version }}" = "alpha" ] || [ "${{ github.event.inputs.gm-hsm-sdf-version }}" = "beta" ] || [ "${{ github.event.inputs.gm-hsm-sdf-version }}" = "rc" ]; then
            # Handle pre-release versions
            PRE_SUFFIX="${{ github.event.inputs.gm-hsm-sdf-version }}"
            CURRENT_VERSION=$(cd gm-hsm-sdf && cargo get package.version --pretty)
            # Remove any existing pre-release suffix and analyze version
            BASE_VERSION=$(echo $CURRENT_VERSION | sed 's/-.*//')
            MAJOR=$(echo $BASE_VERSION | awk -F. '{print $1}')
            MINOR=$(echo $BASE_VERSION | awk -F. '{print $2}')
            PATCH=$(echo $BASE_VERSION | awk -F. '{print $3}')

            if echo $CURRENT_VERSION | grep -q "${PRE_SUFFIX}"; then
              # Already a pre-release version, keep same base, increment prerelease number
              NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
            else
              # Stable version to pre-release: bump minor version (not patch!)
              NEW_MINOR=$((MINOR + 1))
              NEW_VERSION="${MAJOR}.${NEW_MINOR}.0"
            fi
            # Set pre-release version with incrementing number
            if echo $CURRENT_VERSION | grep -q "${PRE_SUFFIX}"; then
              # Increment existing pre-release number
              CURRENT_PRERELEASE=$(echo $CURRENT_VERSION | sed "s/.*-${PRE_SUFFIX}\.\?//" | grep -o '[0-9]*' | head -1)
              if [ -z "$CURRENT_PRERELEASE" ]; then
                CURRENT_PRERELEASE=1
              else
                CURRENT_PRERELEASE=$((CURRENT_PRERELEASE + 1))
              fi
            else
              CURRENT_PRERELEASE=1
            fi
            FINAL_VERSION="${NEW_VERSION}-${PRE_SUFFIX}.${CURRENT_PRERELEASE}"
            # Remove 'v' prefix if present and add quotes
            CLEAN_VERSION=$(echo $FINAL_VERSION | sed 's/^v//')
            cargo set-version "$CLEAN_VERSION" -p gm-hsm-sdf
          elif [ -n "${{ github.event.inputs.gm-hsm-sdf-custom-version }}" ]; then
            # Use custom version (remove 'v' prefix if present)
            CLEAN_CUSTOM_VERSION=$(echo "${{ github.event.inputs.gm-hsm-sdf-custom-version }}" | sed 's/^v//')
            cargo set-version "$CLEAN_CUSTOM_VERSION" -p gm-hsm-sdf
          else
            # Standard semantic version bump
            cargo set-version --bump "${{ github.event.inputs.gm-hsm-sdf-version }}" -p gm-hsm-sdf
          fi
          CRATE_TAG="$(cd gm-hsm-sdf && cargo get package.name)-$(cd gm-hsm-sdf && cargo get package.version --pretty)"
          echo "CRATE_TAG=$CRATE_TAG" >> $GITHUB_ENV
          echo "CRATE_NAME=gm-hsm-sdf" >> $GITHUB_ENV
          git add .
          git commit -am "Release: $CRATE_TAG"
          git tag "$CRATE_TAG"

      - name: "[gm-hsm-sdf] Push to repository"
        if: "${{ github.event.inputs.gm-hsm-sdf-version != 'none' }}"
        uses: ad-m/github-push-action@master
        with:
          branch: ${{ github.ref }}
          tags: true

      - name: "[gm-hsm-sdf] Publish to crates.io"
        if: "${{ github.event.inputs.gm-hsm-sdf-version != 'none' }}"
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN  }}
        run: cargo publish --no-verify -p gm-hsm-sdf